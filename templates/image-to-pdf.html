<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Image to PDF Converter</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #efededff;
      width: 100vw;
      min-height: 100vh;
    }
    body {
      font-family: Arial, sans-serif;
      min-height: 100vh;
      width: 100vw;
      margin: 0;
      padding: 0;
      /* Remove flex centering for full-width panels */
    }
    .upload-container {
      border-radius: 12px;
      padding: 40px 32px;
      text-align: center;
      width: 100%;
      position: relative;
      max-width: 500px;
      margin: 60px auto;
    }
    h2 {
      color: #0e0e0eff;
      font-size: 2rem;
      margin-bottom: 12px;
    }
    .drag-area {
      border-radius: 8px;
      padding: 20px 20px;
      cursor: pointer;
      margin-bottom: 24px;
      transition: background 0.2s, border 0.2s;
    }
    .drag-area.dragover, body.dragover {
      background: #bbdefb;
    }
    .upload-btn {
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 15px;
      padding: 12px 32px;
      font-size: 30px;
      cursor: pointer;
      margin: 12px 0;
      transition: background 0.2s;
      font-weight: 500;
      box-shadow: 0 2px 8px rgba(33,150,243,0.15);
    }
    .upload-btn:hover {
      background: #1565c0;
    }
    #imageInput {
      display: none;
    }
    /* --- Main panels: full screen width --- */
    .main-panels {
      display: flex;
      width: 100vw;
      height: 100vh;
      margin: 0;
      background: #fff;
      border-radius: 0;
      box-shadow: none;
      overflow: hidden;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 10;
    }
    .preview-panel {
      width: 70vw;
      height: 100vh;
      padding: 32px 24px;
      box-sizing: border-box;
      border-right: 1px solid #eee;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      min-height: 100vh;
      overflow-y: auto;
      background: #f7f7f7;
      position: relative;
    }
    .preview-list {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      justify-content: flex-start;
    }
    .preview-item {
      position: relative;
      width: 180px;
      height: 220px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      user-select: none;
      background: #fff;
      border-radius: 12px;
      /* border: 2px solid #1976d2; */
      box-shadow: 0 2px 8px rgba(33,150,243,0.10);
      cursor: grab;
      padding: 12px 8px 8px 8px;
    }
    .preview-img {
      width: 160px;
      height: 160px;
      border-radius: 8px;
      border: none;
      background: transparent;
      box-shadow: none;
      margin-bottom: 8px;
      object-fit: contain; /* <-- Prevent cropping */
      background: #fafafa;
      display: block;
    }
    .delete-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #f44336;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 26px;
      height: 26px;
      cursor: pointer;
      font-size: 20px;
      line-height: 22px;
      text-align: center;
      z-index: 2;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .delete-btn:hover {
      background: #b71c1c;
    }
    .image-name {
      width: 100%;
      text-align: center;
      font-size: 1rem;
      color: #333;
      margin-top: auto; /* Push name to bottom */
      word-break: break-all;
      background: #f7f7f7;
      border-radius: 6px;
      padding: 2px 0;
      position: absolute;
      left: 0;
      bottom: 0;
    }
    .options-panel {
      width: 30vw;
      height: 100vh;
      padding: 32px 24px;
      box-sizing: border-box;
      background: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      overflow-y: auto;
      position: relative; /* Needed for absolute button positioning */
    }
    .options-panel h3 {
      margin-top: 0;
      margin-bottom: 18px;
      color: #1976d2;
      font-size: 1.3rem;
    }
    .options-panel label {
      display: block;
      margin-bottom: 16px;
      font-size: 1rem;
      color: #222;
    }
    .options-panel input, .options-panel select {
      margin-left: 8px;
      padding: 4px 8px;
      font-size: 1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    .options-panel input[type="number"] {
      width: 60px;
    }
    .convert-btn {
      width: 90%;
      max-width: 400px;
      margin: auto;
      margin-top: auto;
      
      display: block;
      padding: 25px 0;
      font-size: 1.5rem;
      font-weight: bold;
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(33,150,243,0.15);
      cursor: pointer;
      transition: background 0.2s;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 24px;
    }
    .convert-btn:hover {
      background: #1565c0;
    }
    /* --- Drag-and-drop visual feedback --- */
    .preview-item.drag-over {
      outline: 2px dashed #1976d2;
      background: #e3f2fd;
    }
    .preview-item.dragging {
      opacity: 0.5;
    }
    .add-image-btn {
      position: fixed;
      top: 40px;
      right: 32vw;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: #1976d2;
      color: #fff;
      border: none;
      font-size: 2rem;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(33,150,243,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      transition: background 0.2s;
      outline: none;
    }
    .add-image-btn:hover {
      background: #1565c0;
    }
    .add-image-tooltip {
      display: none;
      position: absolute;
      top: 52px;
      left: 50%;
      transform: translateX(-50%);
      background: #222;
      color: #fff;
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 1rem;
      white-space: nowrap;
      z-index: 101;
      pointer-events: none;
    }
    .add-image-btn:hover .add-image-tooltip {
      display: block;
    }
  </style>
</head>
<body>
  <!-- Upload panel shown initially -->
  <div class="upload-container" id="uploadContainer">
    <h2>Image to PDF Converter</h2>
    <div class="drag-area" id="dragArea">
      <button class="upload-btn" id="uploadBtn">Upload Images</button>
      <p>or drop images on this page</p>
      <input type="file" id="imageInput" multiple accept="image/*">
    </div>
    <div class="preview-list" id="previewList"></div>
  </div>
  <!-- Main panels shown after images are uploaded -->
  <div class="main-panels" id="mainPanels" style="display:none;">
    <!-- Preview panel: occupies 70% of screen width -->
    <div class="preview-panel">
      <h2 style="display:inline-block;">Preview</h2>
      <button class="add-image-btn" id="addImageBtn" title="Add Images">
        +
        <span class="add-image-tooltip">Add Images</span>
      </button>
      <div class="preview-list" id="panelPreviewList"></div>
    </div>
    <!-- Options panel: occupies 30% of screen width -->
    <div class="options-panel" id="optionsPanel">
      <h3>PDF Options</h3>
      <label>
        Page Orientation:
        <select id="orientation">
          <option value="portrait">Portrait</option>
          <option value="landscape">Landscape</option>
        </select>
      </label>
      <label>
        Page Size:
        <select id="pageSize">
          <option value="fit">Fit to Image</option>
          <option value="a4">A4</option>
        </select>
      </label>
      <label>
        Margin:
        <select id="marginType">
          <option value="none">No Margin</option>
          <option value="custom">Custom (cm)</option>
        </select>
        <input type="number" id="customMargin" min="0" max="10" step="0.1" style="display:none;" placeholder="cm">
      </label>
      <!-- Convert to PDF button at bottom -->
      <button id="convertBtn" class="convert-btn">Convert to PDF</button>
    </div>
  </div>
  <script>
    // --- DOM elements ---
    const dragArea = document.getElementById('dragArea');
    const imageInput = document.getElementById('imageInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const previewList = document.getElementById('previewList');
    const uploadContainer = document.getElementById('uploadContainer');
    const mainPanels = document.getElementById('mainPanels');
    const panelPreviewList = document.getElementById('panelPreviewList');
    const marginType = document.getElementById('marginType');
    const customMargin = document.getElementById('customMargin');
    const addImageBtn = document.getElementById('addImageBtn');

    // --- State: images array ---
    let images = [];

    // --- Upload button opens file dialog ---
    uploadBtn.addEventListener('click', () => imageInput.click());
    addImageBtn.addEventListener('click', () => imageInput.click());

    // --- File input change: add images to preview ---
    imageInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });

    // --- Drag & drop events for the whole page ---
    document.addEventListener('dragover', (e) => {
      e.preventDefault();
      document.body.classList.add('dragover');
      dragArea.classList.add('dragover');
    });

    document.addEventListener('dragleave', (e) => {
      document.body.classList.remove('dragover');
      dragArea.classList.remove('dragover');
    });

    // Drop images anywhere on the page to append to preview
    document.addEventListener('drop', (e) => {
      e.preventDefault();
      document.body.classList.remove('dragover');
      dragArea.classList.remove('dragover');
      if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
        addImagesToPreview(e.dataTransfer.files);
        // Show main panels if hidden
        if (mainPanels.style.display !== 'flex') {
          uploadContainer.style.display = 'none';
          mainPanels.style.display = 'flex';
        }
      }
    });

    // --- Drag events for dragArea (visual feedback only) ---
    dragArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      dragArea.classList.add('dragover');
    });

    dragArea.addEventListener('dragleave', (e) => {
      dragArea.classList.remove('dragover');
    });

    dragArea.addEventListener('drop', (e) => {
      e.preventDefault();
      dragArea.classList.remove('dragover');
      if (e.dataTransfer.files) {
        handleFiles(e.dataTransfer.files);
      }
    });

    // --- Show/hide custom margin input ---
    marginType.addEventListener('change', function() {
      customMargin.style.display = this.value === 'custom' ? 'inline-block' : 'none';
    });

    // --- Add images to preview (append, do not replace) ---
    function addImagesToPreview(files) {
      let filesArr = Array.from(files);
      let loadedCount = 0;
      let newImages = [];
      filesArr.forEach((file, i) => {
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function(e) {
            newImages.push({ name: file.name, dataUrl: e.target.result });
            loadedCount++;
            if (loadedCount === filesArr.length) {
              images = images.concat(newImages);
              renderPanelPreview();
            }
          };
          reader.readAsDataURL(file);
        }
      });
    }

    // --- Initial file upload handler (also appends images) ---
    function handleFiles(files) {
      addImagesToPreview(files);
      // Show main panels if hidden
      if (mainPanels.style.display !== 'flex') {
        uploadContainer.style.display = 'none';
        mainPanels.style.display = 'flex';
      }
    }

    // --- Drag-and-drop reordering logic ---
    let draggedIdx = null;

    function renderPanelPreview() {
      panelPreviewList.innerHTML = '';
      images.forEach((imgObj, idx) => {
        const item = document.createElement('div');
        item.className = 'preview-item';
        item.draggable = true;
        item.dataset.idx = idx;

        // --- Drag events for reordering ---
        item.addEventListener('dragstart', (e) => {
          draggedIdx = idx;
          item.classList.add('dragging');
          e.dataTransfer.effectAllowed = "move";
        });
        item.addEventListener('dragend', (e) => {
          item.classList.remove('dragging');
          Array.from(panelPreviewList.children).forEach(child => child.classList.remove('drag-over'));
          draggedIdx = null;
        });
        item.addEventListener('dragover', (e) => {
          e.preventDefault();
          item.classList.add('drag-over');
        });
        item.addEventListener('dragleave', (e) => {
          item.classList.remove('drag-over');
        });
        item.addEventListener('drop', (e) => {
          e.preventDefault();
          item.classList.remove('drag-over');
          if (draggedIdx !== null && draggedIdx !== idx) {
            const moved = images.splice(draggedIdx, 1)[0];
            images.splice(idx, 0, moved);
            renderPanelPreview();
          }
        });
        item.addEventListener('drop', (e) => {
          e.stopPropagation();
        });

        // --- Image preview ---
        const img = document.createElement('img');
        img.src = imgObj.dataUrl;
        img.className = 'preview-img';

        // --- Delete button ---
        const delBtn = document.createElement('button');
        delBtn.className = 'delete-btn';
        delBtn.innerHTML = '&times;';
        delBtn.title = 'Delete';
        delBtn.onclick = () => {
          images.splice(idx, 1);
          renderPanelPreview();
          if (images.length === 0) {
            mainPanels.style.display = 'none';
            uploadContainer.style.display = 'block';
          }
        };

        // --- Image name at bottom ---
        const nameDiv = document.createElement('div');
        nameDiv.className = 'image-name';
        nameDiv.textContent = imgObj.name;

        item.appendChild(img);
        item.appendChild(delBtn);
        item.appendChild(nameDiv);
        panelPreviewList.appendChild(item);
      });
    }

    // --- Allow dropping images directly onto preview panel to append ---
    panelPreviewList.addEventListener('dragover', (e) => {
      e.preventDefault();
    });
    panelPreviewList.addEventListener('drop', (e) => {
      e.preventDefault();
      if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
        addImagesToPreview(e.dataTransfer.files);
      }
    });

    document.getElementById('convertBtn').addEventListener('click', async () => {
      if (images.length === 0) {
        alert("Please add images first.");
        return;
      }
      const formData = new FormData();
      images.forEach((imgObj, idx) => {
        // Convert base64 to Blob
        const arr = imgObj.dataUrl.split(',');
        const mime = arr[0].match(/:(.*?);/)[1];
        const bstr = atob(arr[1]);
        let n = bstr.length;
        const u8arr = new Uint8Array(n);
        while(n--) u8arr[n] = bstr.charCodeAt(n);
        const file = new File([u8arr], imgObj.name, {type: mime});
        formData.append('images', file);
      });

      const res = await fetch('/convert-images', {
        method: 'POST',
        body: formData
      });

      if (res.ok) {
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "converted.pdf";
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
      } else {
        alert("PDF conversion failed.");
      }
    });
  </script>
</body>
</html>